# 位置校准功能说明

## 概述

已成功将位置校准管理器集成到称重工具中，实现了基于按压重心距离的智能校准功能。

## 主要功能

### 1. 位置校准数据存储
- **文件格式**: JSON格式存储
- **存储内容**: 
  - 9个不同位置的校准关系（斜率、截距、R²等）
  - 位置坐标信息
  - 校准质量指标
  - 元数据和设置配置

### 2. 智能位置选择
- **压力重心计算**: 自动计算64x64压力数据的重心坐标
- **距离计算**: 支持欧几里得、曼哈顿、切比雪夫距离
- **最近位置查找**: 根据压力重心找到最近的校准位置
- **质量阈值检查**: 基于R²值判断校准质量

### 3. UI界面改进
- **隐藏具体系数**: 不再显示具体的斜率、截距数值
- **显示位置信息**: 实时显示当前使用的位置名称
- **距离和质量指示**: 显示距离最近校准位置的距离和校准质量
- **动态公式更新**: 根据选择的位置动态更新计算公式

### 4. 校准数据管理
- **加载位置校准**: 从JSON文件加载位置校准数据
- **保存位置校准**: 将位置校准数据保存到JSON文件
- **位置校准信息**: 查看所有位置的校准参数和统计信息
- **兼容性加载**: 支持加载传统校准数据和位置校准数据

### 5. 智能归零逻辑
- **归零前**: 使用完整校准方程 `重量 = 斜率 × 压力 + 截距`
- **归零后**: 只使用斜率 `重量 = 斜率 × (当前压力 - 归零压力)`
- **偏置消除**: 归零操作自动消除偏置影响，提高测量精度

### 6. 实时热力图显示
- **2D压力分布**: 实时显示64×64压力数据的2D热力图
- **Y轴朝下**: 热力图Y轴设置为朝下，符合传感器坐标系统
- **坐标转置**: 数据自动转置以正确显示坐标位置
- **颜色映射**: 使用viridis颜色映射显示压力强度
- **实时更新**: 随着传感器数据更新实时刷新热力图
- **缩放控制**: 支持自动缩放和重置缩放功能
- **信息显示**: 显示总压力、平均压力、最大压力和数据范围

### 7. 校正数据分析弹窗
- **多选项卡界面**: 统计信息、热力图对比、差异分析、校正映射信息
- **统计信息对比**: 显示原始数据和校正后数据的详细统计信息
- **热力图对比**: 并排显示原始和校正后数据的热力图
- **差异分析**: 显示校正差异的统计和热力图，使用双极颜色映射
- **校正映射信息**: 显示校正映射的详细信息和热力图
- **导出功能**: 支持导出分析报告为文本文件
- **校正效果验证**: 自动检测校正是否生效

## 技术实现

### 核心类
1. **PositionCalibrationManager**: 位置校准管理器
   - 负责加载/保存校准数据
   - 计算压力重心
   - 查找最近位置
   - 获取校准参数
   - 智能归零重量计算

2. **WeightMeasurementWidget**: 称重组件
   - 集成位置校准管理器
   - 智能选择校准关系
   - 更新UI显示
   - 归零状态管理

3. **CalibrationDataLoader**: 校准数据加载器
   - 支持多种文件格式（JSON、CSV、NumPy）
   - 兼容位置校准数据格式
   - 自动识别数据格式并加载

### 工作流程
1. 获取64x64压力数据
2. 计算压力重心坐标
3. 找到距离最近的校准位置
4. 根据归零状态选择计算公式：
   - 未归零：`重量 = 斜率 × 压力 + 截距`
   - 已归零：`重量 = 斜率 × (当前压力 - 归零压力)`
5. 更新UI显示位置信息
6. 更新热力图显示压力分布

### 热力图技术实现
- **pyqtgraph**: 使用pyqtgraph库实现高性能2D图像显示
- **ImageItem**: 使用ImageItem组件显示64×64压力矩阵
- **ColorBarItem**: 集成颜色条显示压力强度范围
- **坐标系统**: 设置Y轴朝下（invertY=True）
- **数据转置**: 使用numpy.T转置数据以正确显示坐标位置
- **实时更新**: 通过setImage方法实时更新图像数据
- **自动缩放**: 支持自动范围调整和手动缩放控制

### 校正分析弹窗技术实现
- **QDialog**: 使用QDialog创建模态弹窗
- **QTabWidget**: 使用选项卡组织不同分析内容
- **数据对比**: 实时保存原始数据和校正后数据
- **统计分析**: 计算总压力、平均值、标准差、变异系数等
- **热力图对比**: 并排显示原始和校正后数据
- **差异分析**: 计算校正差异并使用双极颜色映射显示
- **报告导出**: 生成详细的分析报告文本文件

### 校准参数
每个位置包含：
- `slope`: 斜率（g/N）
- `intercept`: 截距（g）
- `r_squared`: 校准质量（R²值）
- `measurement_count`: 测量次数
- `last_updated`: 最后更新时间

## 使用方法

### 1. 启动程序
```bash
python weight_measurement_tool.py
```

### 2. 位置校准模式
- 程序自动检测并启用位置校准功能
- UI显示"校准模式: 位置智能校准"
- 隐藏系数和偏置输入框

### 3. 归零操作
- 点击"归零"按钮进行归零操作
- 归零后公式自动更新为：`重量 = 斜率 × (当前压力 - 归零压力)`
- 归零后不再显示截距信息

### 4. 实时显示
- **当前位置**: 显示当前使用的校准位置名称
- **距离**: 显示距离最近校准位置的距离
- **校准质量**: 显示R²值和质量等级
- **压力重心**: 显示计算出的压力重心坐标
- **公式**: 根据归零状态动态显示计算公式
- **热力图**: 实时显示64×64压力分布热力图

### 5. 热力图操作
- **自动缩放**: 点击"自动缩放"按钮自动调整热力图显示范围
- **重置缩放**: 点击"重置缩放"按钮恢复到默认视图
- **实时信息**: 热力图下方显示压力统计信息
- **颜色条**: 右侧颜色条显示压力强度范围
- **Y轴朝下**: 热力图Y轴设置为朝下，符合传感器坐标
- **坐标转置**: 数据自动转置，确保坐标位置正确显示

### 6. 校正分析
- **校正分析按钮**: 点击"校正分析"按钮打开分析弹窗
- **统计信息选项卡**: 查看原始和校正后数据的统计对比
- **热力图对比选项卡**: 并排查看原始和校正后数据的热力图
- **差异分析选项卡**: 查看校正差异的统计和热力图
- **校正映射信息选项卡**: 查看校正映射的详细信息
- **导出报告**: 点击"导出分析报告"保存详细分析结果

### 7. 数据管理
- **保存位置校准**: 点击"保存位置校准"按钮
- **加载位置校准**: 点击"加载位置校准"按钮
- **查看位置信息**: 点击"位置校准信息"按钮
- **加载传统校准**: 支持加载传统格式的校准数据

## 文件结构

```
balance-sensor/
├── position_calibration_data.json    # 位置校准数据文件
├── position_calibration_manager.py   # 位置校准管理器
├── weight_measurement_tool.py        # 修改后的称重工具
├── test_position_calibration.py      # 位置校准测试
├── test_weight_tool_integration.py   # 集成测试
└── 位置校准功能说明.md               # 功能说明文档
```

## 测试结果

### 功能测试
- ✅ 压力重心计算准确
- ✅ 距离计算正确
- ✅ 最近位置查找准确
- ✅ 重量计算精度高（误差<0.01g）
- ✅ 不同位置使用不同校准关系

### 集成测试
- ✅ 模块导入成功
- ✅ 位置校准管理器初始化成功
- ✅ 模拟压力数据创建成功
- ✅ 重量计算功能正常
- ✅ 不同位置重量计算正确

### 校准加载测试
- ✅ 位置校准数据加载成功
- ✅ 传统校准数据兼容性
- ✅ UI界面正确更新
- ✅ 错误处理机制完善

### 归零逻辑测试
- ✅ 归零前使用完整校准方程
- ✅ 归零后只使用斜率
- ✅ 偏置正确消除
- ✅ 公式显示正确更新

### 热力图功能测试
- ✅ pyqtgraph库正确导入
- ✅ 热力图组件成功创建
- ✅ Y轴朝下设置正确
- ✅ 颜色条集成成功
- ✅ 实时数据更新正常
- ✅ 缩放控制功能正常
- ✅ 坐标转置功能正确

### 校正分析弹窗测试
- ✅ 弹窗界面成功创建
- ✅ 多选项卡功能正常
- ✅ 统计信息计算正确
- ✅ 热力图对比显示正常
- ✅ 差异分析功能正常
- ✅ 校正映射信息显示正确
- ✅ 报告导出功能正常
- ✅ 校正效果检测准确

## 优势特点

1. **智能化**: 自动根据按压位置选择最合适的校准关系
2. **高精度**: 基于距离和R²值的双重质量保证
3. **用户友好**: 隐藏复杂参数，显示直观的位置信息
4. **可扩展**: 支持添加更多校准位置
5. **数据管理**: 完整的校准数据保存和加载功能
6. **兼容性**: 支持传统校准数据和位置校准数据
7. **智能归零**: 归零后自动消除偏置，提高测量精度
8. **可视化**: 实时2D热力图显示压力分布，Y轴朝下符合传感器坐标
9. **坐标准确**: 数据自动转置确保坐标位置正确显示
10. **校正验证**: 完整的校正数据分析弹窗，验证校正效果

## 注意事项

1. **校准数据**: 确保`position_calibration_data.json`文件存在且格式正确
2. **位置覆盖**: 当前包含9个校准位置，覆盖传感器主要区域
3. **备用机制**: 当无法找到合适位置时，自动使用备用校准
4. **质量阈值**: R²值低于0.95的位置会被标记为低质量
5. **加载兼容性**: 支持加载传统校准数据和位置校准数据
6. **归零操作**: 归零后偏置自动消除，无需手动调整
7. **热力图显示**: 需要pyqtgraph库支持，确保已正确安装
8. **性能优化**: 热力图实时更新可能影响性能，建议在需要时启用

## 问题修复

### 已修复的问题
1. **UI属性错误**: 修复了位置校准模式下访问不存在UI元素的问题
2. **校准加载失败**: 修复了加载位置校准数据时的格式识别问题
3. **初始化错误**: 修复了程序启动时的属性访问错误
4. **归零逻辑**: 实现了归零后不使用偏置的正确逻辑
5. **热力图集成**: 成功集成pyqtgraph热力图显示功能

### 修复内容
- 在`load_calibration`方法中添加了模式检查
- 在`CalibrationDataLoader`中添加了位置校准数据格式支持
- 在`init_ui`方法中修复了初始化调用问题
- 在`calculate_weight`方法中实现了智能归零逻辑
- 在UI显示中正确反映归零状态
- 在`init_ui`方法中添加了热力图组件
- 在`update_data`方法中添加了热力图更新调用
- 在`update_heatmap`方法中添加了数据转置功能

## 下一步改进

1. **动态校准**: 支持实时更新校准参数
2. **更多位置**: 增加更多校准位置点
3. **插值算法**: 实现位置间的插值校准
4. **可视化**: 添加位置分布的可视化显示
5. **批量校准**: 支持批量校准数据管理
6. **归零优化**: 支持多点归零和归零历史记录 