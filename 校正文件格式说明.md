# 校正文件格式说明

## 概述

校正文件是传感器校正系统的核心输出，包含了将原始传感器数据转换为校正后数据的映射关系。本文档详细说明了校正文件的格式、结构和实现原理。

## 文件类型

### 1. 校正映射文件 (.npy)

**文件格式**: NumPy二进制数组文件  
**文件大小**: 约32KB (64x64传感器阵列)  
**数据结构**: 2D NumPy数组，形状与传感器阵列相同

### 2. 参考数据文件

**JSON格式**: 包含时间戳和元数据的文本格式  
**NPY格式**: 纯NumPy数组格式，文件较小

## 校正映射文件详细说明

### 文件结构

```python
# 校正映射文件结构
calibration_map.shape = (64, 64)  # 传感器阵列形状
calibration_map.dtype = float64   # 数据类型
calibration_map.size = 4096       # 总元素数
```

### 数据含义

每个元素 `calibration_map[i, j]` 表示位置 `(i, j)` 处传感器的校正系数：

- **校正系数 > 1.0**: 该传感器响应偏低，需要放大
- **校正系数 = 1.0**: 该传感器响应正常，无需校正
- **校正系数 < 1.0**: 该传感器响应偏高，需要缩小

### 校正公式

```python
# 校正公式
corrected_data[i, j] = raw_data[i, j] × calibration_map[i, j]
```

## 校正实现原理

### 1. 参考数据收集

使用均匀物体（如书本、平板）压在传感器表面，收集理想的均匀响应数据：

```python
# 收集多帧数据并计算平均值
reference_data = np.mean(collected_frames, axis=0)
```

### 2. 目标值计算

以中位数作为目标响应值，确保校正的稳定性：

```python
# 过滤有效数据
valid_data = reference_data[reference_data > threshold]
target_response = np.median(valid_data)
```

### 3. 校正映射生成

计算每个传感器的校正系数：

```python
# 生成校正映射
calibration_map = np.ones_like(reference_data)
valid_mask = reference_data > threshold
calibration_map[valid_mask] = target_response / reference_data[valid_mask]

# 限制校正系数范围，避免过度校正
calibration_map = np.clip(calibration_map, 0.2, 5.0)
```

### 4. 实时校正应用

对实时数据进行校正：

```python
def apply_correction(raw_data, calibration_map):
    """应用校正到原始数据"""
    return raw_data * calibration_map
```

## 文件示例

### 校正映射文件内容示例

```python
import numpy as np

# 加载校正映射
calibration_map = np.load("example_calibration_map.npy")

print(f"文件形状: {calibration_map.shape}")
print(f"数据类型: {calibration_map.dtype}")
print(f"数值范围: {calibration_map.min():.3f} - {calibration_map.max():.3f}")
print(f"平均值: {calibration_map.mean():.3f}")
print(f"标准差: {calibration_map.std():.3f}")

# 显示部分数据
print("\n校正映射示例 (左上角 8x8 区域):")
print(calibration_map[:8, :8])
```

### 参考数据文件内容示例

```json
{
  "reference_data": [[0.123, 0.456, ...], ...],
  "timestamp": "2024-01-15T10:30:00",
  "frame_count": 100,
  "target_response": 0.5333,
  "calibration_range": [0.521, 5.000]
}
```

## 校正效果评估

### 一致性指标

- **变异系数 (CV)**: `std / mean`
- **改善程度**: `(original_cv - corrected_cv) / original_cv × 100%`

### 评估标准

| 改善程度 | 校正效果 |
|----------|----------|
| > 50% | 优秀 |
| 30-50% | 良好 |
| 10-30% | 一般 |
| < 10% | 不明显 |

## 文件操作

### 保存校正映射

```python
import numpy as np

# 保存校正映射
np.save("calibration_map.npy", calibration_map)
```

### 加载校正映射

```python
import numpy as np

# 加载校正映射
calibration_map = np.load("calibration_map.npy")
```

### 验证文件完整性

```python
def validate_calibration_file(filename):
    """验证校正文件的完整性"""
    try:
        calibration_map = np.load(filename)
        
        # 检查形状
        if calibration_map.shape != (64, 64):
            return False, "形状不正确"
        
        # 检查数值范围
        if calibration_map.min() < 0.1 or calibration_map.max() > 10.0:
            return False, "数值范围异常"
        
        # 检查数据类型
        if calibration_map.dtype != np.float64:
            return False, "数据类型不正确"
        
        return True, "文件有效"
        
    except Exception as e:
        return False, f"文件损坏: {e}"
```

## 实际应用示例

### 完整校正流程

```python
import numpy as np

# 1. 加载校正映射
calibration_map = np.load("calibration_map.npy")

# 2. 获取实时传感器数据
raw_data = get_sensor_data()  # 假设函数

# 3. 应用校正
corrected_data = raw_data * calibration_map

# 4. 显示结果
print(f"原始数据CV: {raw_data.std()/raw_data.mean():.1%}")
print(f"校正后CV: {corrected_data.std()/corrected_data.mean():.1%}")
```

### 批量处理

```python
def batch_correct_sensor_data(data_files, calibration_map):
    """批量校正传感器数据"""
    corrected_files = []
    
    for file in data_files:
        raw_data = np.load(file)
        corrected_data = raw_data * calibration_map
        
        # 保存校正后的数据
        output_file = file.replace('.npy', '_corrected.npy')
        np.save(output_file, corrected_data)
        corrected_files.append(output_file)
    
    return corrected_files
```

## 注意事项

### 1. 文件兼容性

- 校正映射文件与传感器阵列形状必须匹配
- 不同版本的校正文件可能不兼容
- 建议保存校正文件的版本信息

### 2. 数值精度

- 使用float64数据类型确保精度
- 校正系数范围限制在0.2-5.0之间
- 避免过度校正导致的数据失真

### 3. 文件管理

- 定期备份重要的校正文件
- 为不同场景保存不同的校正文件
- 记录校正文件的生成时间和参数

### 4. 性能考虑

- 校正操作是简单的矩阵乘法，计算效率高
- 大文件校正时考虑内存使用
- 实时校正时注意延迟控制

## 故障排除

### 常见问题

1. **文件加载失败**
   - 检查文件路径是否正确
   - 确认文件格式是否为.npy
   - 验证文件是否损坏

2. **校正效果不明显**
   - 检查校正映射是否有效
   - 确认参考数据质量
   - 重新进行校正过程

3. **数据异常**
   - 检查校正系数范围
   - 验证传感器数据格式
   - 确认校正映射形状匹配

### 调试工具

```python
def debug_calibration_file(filename):
    """调试校正文件"""
    try:
        calibration_map = np.load(filename)
        
        print(f"文件信息:")
        print(f"  形状: {calibration_map.shape}")
        print(f"  数据类型: {calibration_map.dtype}")
        print(f"  数值范围: {calibration_map.min():.3f} - {calibration_map.max():.3f}")
        print(f"  平均值: {calibration_map.mean():.3f}")
        print(f"  标准差: {calibration_map.std():.3f}")
        
        # 检查异常值
        outliers = np.sum((calibration_map < 0.1) | (calibration_map > 10.0))
        print(f"  异常值数量: {outliers}")
        
        return True
        
    except Exception as e:
        print(f"错误: {e}")
        return False
```

## 总结

校正文件是传感器校正系统的核心，通过简单的矩阵乘法实现实时数据校正。正确的文件格式和操作可以显著提升传感器的一致性和测量精度。 