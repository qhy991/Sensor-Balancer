import json
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats
import os

# è®¾ç½® Matplotlib æ”¯æŒä¸­æ–‡æ˜¾ç¤º
plt.rcParams['font.sans-serif'] = ['SimHei']  # æŒ‡å®šé»˜è®¤å­—ä½“ä¸ºé»‘ä½“
plt.rcParams['axes.unicode_minus'] = False  # è§£å†³ä¿å­˜å›¾åƒæ˜¯è´Ÿå·'-'æ˜¾ç¤ºä¸ºæ–¹å—çš„é—®é¢˜

def load_data(filepath='data.json'):
    """åŠ è½½å¹¶è¿”å›JSONæ•°æ®"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"é”™è¯¯: æ–‡ä»¶æœªæ‰¾åˆ° '{filepath}'")
        return None
    except json.JSONDecodeError:
        print(f"é”™è¯¯: æ–‡ä»¶æ ¼å¼æ— æ•ˆ '{filepath}'")
        return None

def analyze_calibration_model(data):
    """
    æ–°å¢åŠŸèƒ½: ä»¥æ€»å‹åŠ›ä¸ºXï¼Œç ç é‡é‡ä¸ºYï¼Œè¿›è¡Œå›å½’åˆ†æã€‚
    è¿™ç”¨äºå»ºç«‹ä¸€ä¸ªâ€œæ ¡å‡†æ¨¡å‹â€ï¼Œå³é€šè¿‡å‹åŠ›è¯»æ•°é¢„æµ‹é‡é‡ã€‚
    """
    print("\n" + "="*50)
    print("ğŸ“Š æ–°å¢: æ ¡å‡†æ¨¡å‹åˆ†æ (æ€»å‹åŠ› -> ç ç é‡é‡)")
    print("="*50)

    consistency_results = data.get("consistency_results", {})
    guide_positions = data.get("guide_positions", {})
    
    # --- 1. é€ä¸ªä½ç½®çš„æ ¡å‡†æ¨¡å‹ ---
    output_dir_individual = "calibration_model_plots"
    os.makedirs(output_dir_individual, exist_ok=True)
    print(f"ç‹¬ç«‹çš„æ ¡å‡†æ¨¡å‹å›¾è¡¨å°†ä¿å­˜åˆ° '{output_dir_individual}' ç›®å½•ä¸­ã€‚\n")

    for position, measurements in consistency_results.items():
        pos_name = guide_positions.get(position, {}).get("name", position)
        
        # æå–æ•°æ®ç‚¹ï¼ŒXä¸ºå‹åŠ›ï¼ŒYä¸ºè´¨é‡
        pressures = np.array([d["avg_total_pressure"] for d in measurements.values()])
        masses = np.array([d["weight_info"]["mass"] for d in measurements.values()])
        
        if len(masses) < 3:
            continue
            
        # è¿›è¡Œçº¿æ€§å›å½’: y = slope * x + intercept  (Mass = slope * Pressure + intercept)
        slope, intercept, r_value, p_value, std_err = stats.linregress(pressures, masses)
        r_squared = r_value**2

        print(f"--- ä½ç½®: {pos_name} çš„æ ¡å‡†æ¨¡å‹ ---")
        print(f"  - æ ¡å‡†æ–œç‡ (g/pressure_unit): {slope:.4f}")
        print(f"  - æ ¡å‡†æˆªè· (g): {intercept:.4f}")
        print(f"  - RÂ²: {r_squared:.4f}")

        plt.figure(figsize=(10, 6))
        sns.scatterplot(x=pressures, y=masses, s=100, label="æµ‹é‡æ•°æ®")
        line_x = np.array([min(pressures), max(pressures)])
        line_y = slope * line_x + intercept
        plt.plot(line_x, line_y, color='green', linestyle='--', label="æ ¡å‡†æ¨¡å‹å›å½’çº¿")
        
        title_text = (
            f"ä½ç½®: {pos_name} çš„æ ¡å‡†æ¨¡å‹ (å‹åŠ›->é‡é‡)\n"
            f"æ ¡å‡†æ–¹ç¨‹: é‡é‡ = {slope:.2f} * å‹åŠ› + {intercept:.2f}\n"
            f"$R^2$ = {r_squared:.4f}"
        )
        plt.title(title_text)
        plt.xlabel("å¹³å‡æ€»å‹åŠ› (avg_total_pressure)")
        plt.ylabel("ç ç è´¨é‡ (g)")
        plt.grid(True)
        plt.legend()
        
        filename = f"{output_dir_individual}/{position}_calibration_model.png"
        plt.savefig(filename)
        plt.close()
    
    print("\nå·²ä¸ºæ¯ä¸ªä½ç½®ç”Ÿæˆç‹¬ç«‹çš„æ ¡å‡†æ¨¡å‹å›¾è¡¨ã€‚")
    
    # --- 2. æ•´ä½“çš„æ ¡å‡†æ¨¡å‹ ---
    all_masses = []
    all_pressures = []
    all_pos_names = []

    for position, measurements in consistency_results.items():
        pos_name = guide_positions.get(position, {}).get("name", position)
        for details in measurements.values():
            all_pressures.append(details["avg_total_pressure"])
            all_masses.append(details["weight_info"]["mass"])
            all_pos_names.append(pos_name)

    # è¿›è¡Œæ€»å›å½’
    slope_all, intercept_all, r_value_all, _, _ = stats.linregress(all_pressures, all_masses)
    r_squared_all = r_value_all**2

    print("\n" + "-"*50)
    print("--- ä¼ æ„Ÿå™¨æ•´ä½“æ ¡å‡†æ¨¡å‹ (æ‰€æœ‰ç‚¹èšåˆ) ---")
    print(f"  - æ•´ä½“æ ¡å‡†æ–œç‡ (g/pressure_unit): {slope_all:.4f}")
    print(f"  - æ•´ä½“æ ¡å‡†æˆªè· (g): {intercept_all:.4f}")
    print(f"  - æ•´ä½“ RÂ²: {r_squared_all:.4f}")
    if r_squared_all < 0.9:
        print("  - ç»“è®º: æ•´ä½“ RÂ² å€¼è¾ƒä½ï¼Œè¯´æ˜å¦‚æœä½¿ç”¨å•ä¸€æ¨¡å‹å¯¹æ‰€æœ‰ä½ç½®è¿›è¡Œé¢„æµ‹ï¼Œè¯¯å·®ä¼šéå¸¸å¤§ã€‚è¿™å†æ¬¡è¯æ˜äº†ä½ç½®ä¸€è‡´æ€§æ˜¯ä¸»è¦é—®é¢˜ã€‚")
    else:
        print("  - ç»“è®º: æ•´ä½“æ•°æ®ç‚¹é«˜åº¦ç›¸å…³ï¼Œä½†ä»éœ€å…³æ³¨ç¦»æ•£æƒ…å†µã€‚")

    plt.figure(figsize=(14, 9))
    sns.scatterplot(x=all_pressures, y=all_masses, hue=all_pos_names, s=80, palette="tab10")
    
    line_x_all = np.array([min(all_pressures), max(all_pressures)])
    line_y_all = slope_all * line_x_all + intercept_all
    plt.plot(line_x_all, line_y_all, color='black', linestyle='--', linewidth=2.5, label="æ•´ä½“æ ¡å‡†å›å½’çº¿")
    
    title_text = (
        f"ä¼ æ„Ÿå™¨æ•´ä½“æ ¡å‡†æ¨¡å‹ (æ‰€æœ‰ä½ç½®èšåˆ)\n"
        f"æ•´ä½“æ ¡å‡†æ–¹ç¨‹: é‡é‡ = {slope_all:.2f} * å‹åŠ› + {intercept_all:.2f}\n"
        f"æ•´ä½“ $R^2$ = {r_squared_all:.4f}"
    )
    plt.title(title_text, fontsize=16)
    plt.xlabel("å¹³å‡æ€»å‹åŠ› (avg_total_pressure)", fontsize=12)
    plt.ylabel("ç ç è´¨é‡ (g)", fontsize=12)
    plt.grid(True, which='both', linestyle='--', linewidth=0.5)
    plt.legend(title="ä¼ æ„Ÿå™¨ä½ç½®", bbox_to_anchor=(1.02, 1), loc='upper left')
    plt.tight_layout(rect=[0, 0, 0.88, 1])

    output_dir_combined = "." # ä¿å­˜åˆ°ä¸»ç›®å½•
    filename = f"{output_dir_combined}/combined_calibration_model.png"
    plt.savefig(filename)
    plt.close()
    
    print(f"\næ•´ä½“æ ¡å‡†æ¨¡å‹å›¾è¡¨å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°: '{filename}'")

def main():
    """ä¸»å‡½æ•°ï¼Œæ‰§è¡Œæ‰€æœ‰åˆ†æ"""
    # å‡è®¾æ‚¨çš„JSONæ–‡ä»¶ä¸è„šæœ¬åœ¨åŒä¸€ç›®å½•ä¸‹
    filepath = 'C:/Users/84672/Documents/Research/balance-sensor/consistency-test/0801-3-å®Œæ•´.json' 
    sensor_data = load_data(filepath)
    
    if sensor_data:
        # æ–°å¢çš„æ ¡å‡†æ¨¡å‹åˆ†æ (å‹åŠ› -> é‡é‡)
        analyze_calibration_model(sensor_data)
        
        # è¿™é‡Œå¯ä»¥æ³¨é‡Šæ‰ä¹‹å‰çš„åˆ†æï¼Œå¦‚æœä¸æƒ³é‡å¤ç”Ÿæˆ
        # print("\n\n" + "#"*60)
        # print("ä»¥ä¸‹ä¸ºåŸå§‹åˆ†æ (é‡é‡ -> å‹åŠ›)")
        # print("#"*60)
        # analyze_and_plot_linearity(sensor_data)
        # analyze_and_plot_consistency(sensor_data)
        # plot_combined_linearity(sensor_data)
        
        print("\n" + "="*50)
        print("âœ… åˆ†æå®Œæˆã€‚")
        print("="*50)

if __name__ == "__main__":
    # åœ¨è¿è¡Œå‰ï¼Œè¯·ç¡®ä¿ 'data.json' æ–‡ä»¶å­˜åœ¨äºè„šæœ¬æ‰€åœ¨çš„ç›®å½•ä¸­
    # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª
    if not os.path.exists('C:/Users/84672/Documents/Research/balance-sensor/consistency-test/0801-3-å®Œæ•´.json'):
        print("æœªæ‰¾åˆ° 'data.json'ï¼Œæ­£åœ¨æ ¹æ®ä¹‹å‰çš„å¯¹è¯åˆ›å»ºç¤ºä¾‹æ–‡ä»¶...")
        # (æ­¤å¤„åº”å¡«å…¥ä¹‹å‰å¯¹è¯ä¸­çš„å®Œæ•´JSONæ•°æ®)
        # ä¸ºç®€æ´èµ·è§ï¼Œè¿™é‡Œå‡è®¾æ–‡ä»¶å·²å­˜åœ¨ã€‚åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¯·ç¡®ä¿æ–‡ä»¶å°±ä½ã€‚
        # å¦‚æœæ‚¨åœ¨æœ¬åœ°è¿è¡Œï¼Œè¯·å°†æ‚¨çš„JSONæ•°æ®ä¿å­˜ä¸º data.json
        print("è¯·ç¡®ä¿ 'data.json' æ–‡ä»¶å·²å‡†å¤‡å¥½ï¼Œç„¶åé‡æ–°è¿è¡Œè„šæœ¬ã€‚")
    else:
        main()